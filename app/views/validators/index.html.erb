<p id="notice"><%= notice %></p>
<h1><%= params[:network].capitalize%> Validators</h1>
<div class="row">
  <div class="col-lg-12">
    <p>
      Meet the validators who power Solana, the world's fastest blockchain! The table below show each validator by name and includes some recent statistics for each. You will also see color-coded validator scores (beta) to help you assess the relative performance of each node. See our <%= link_to 'FAQ', faq_url, target: '_blank' %> to learn how the scores are calculated. <small>(You can also hover your mouse over the circular score icons below for a short description.)</small>
    </p>
    <p>Special thanks to <%= link_to 'Staking Facilities', 'https://stakingfacilities.com/', target: '_blank' %> for their support!</p>
  </div>
</div>
<% unless @validators.empty? %>
  <div class="row">
    <div class="col-lg-12">
      <small>
        Data updated at <%= @batch.created_at %> in batch <%= @batch.uuid %>
      </small>
      <table id="validators-table" class='table table-striped'>
        <thead class="thead-dark">
          <tr>
            <th>&nbsp;</th>
            <th>
              Name <small>(Commission)</small><br />
              Active Stake <small>(<%= number_to_human(lamports_to_sol(@total_active_stake)) %> SOL)</small><br />
              Software <small>(<%= Rails.application.credentials.solana["software_patch_#{params[:network]}".to_sym] %>)</small><br />
              Scores <small>(total)</small>
            </th>
            <th class='text-right'>Root Block<br />Distance</th>
            <th class='text-right'>Vote<br />Distance</th>
            <th class='text-right'>Skipped<br />Slot &percnt;</th>
            <th class='text-right'>Skipped<br />After Slot &percnt;</th>
            <th class='text-right'>Average<br />Ping Time (ms)</th>
          </tr>
        </thead>

        <tbody>
          <tr>
            <td colspan="2">
              Cluster Height/Stats:<br />
              Epoch: <%= @this_epoch.epoch %>
            </td>
            <td class='text-right'>
              <%= number_with_delimiter @tower_highest_block %>
            </td>
            <td class='text-right'>
              <%= number_with_delimiter @tower_highest_vote %>
            </td>
            <td class='text-right'>
              Med: <%= number_to_percentage(@skipped_slot_median.to_f * 100.0) %><br />
              Avg: <%= number_to_percentage(@skipped_slot_average.to_f * 100.0) %>
            </td>
            <td class='text-right'>
              Med: <%= number_to_percentage(@skipped_after_median.to_f * 100.0) %><br />
              Avg: <%= number_to_percentage(@skipped_after_average.to_f * 100.0) %>
            </td>
            <td class='text-right'>
              Avg: <%= @ping_time_avg.nil? ? 'N/A' : @ping_time_avg&.to_f.round(1)  %>
            </td>
          </tr>
          <% i = 0 %>
          <% @validators.each do |validator| %>
          <% i += 1 %>
            <tr>
              <td>
                <small><%= i %></small>&nbsp;
                <span class="avatar">
                  <% if validator.avatar_url %>
                    <%= image_tag validator.avatar_url, class: 'img-circle' %>
                  <% else %>
                    <%= image_tag 'https://keybase.io/images/no-photo/placeholder-avatar-180-x-180@2x.png', class: 'img-circle' %>
                  <% end %>
                </span>
                </td>
                <td>
                <%
                  validator_name = if validator.name
                    validator.name
                  else
                    shorten_key(validator.account)
                  end
                %>
                  <%= link_to validator_name, validator_url(network: params[:network], account: validator.account) %>
                  <small>(<%= validator.commission %>%)</small><br />
                  <small>
                    <%= number_with_delimiter lamports_to_sol(validator.active_stake) %>
                    (<%= number_to_percentage(validator.stake_concentration.to_f * 100.0, precision: 1) %>)
                  </small>
                  <br />
                  <small  class="<%= software_color_class(validator.software_version) %>">
                    <%= validator.software_version || 'N/A' %>
                  </small>
                  <br />
                  <small>
                    <i class="fas fa-circle score-<%= validator.root_distance_score %>"
                       title="Root Distance Score = <%= validator.root_distance_score %>"></i>&nbsp;
                    <i class="fas fa-circle score-<%= validator.vote_distance_score %>"
                       title="Vote Distance Score = <%= validator.vote_distance_score %>"></i>&nbsp;
                    <i class="fas fa-circle score-<%= validator.skipped_slot_score %>"
                       title="Skipped Slot Score = <%= validator.skipped_slot_score %>"></i>&nbsp;
                   <i class="fas fa-circle score-<%= validator.skipped_after_score %>"
                      title="Skipped After Score = <%= validator.skipped_after_score %>"></i>&nbsp;
                   <i class="fas fa-circle score-<%= validator.software_version_score %>"
                      title="Software Version Score = <%= validator.software_version_score %>"></i>&nbsp;
                    <% if validator.stake_concentration_score < 0 %>
                      <%
                        score_class = \
                          if validator.stake_concentration_score == -2
                            'score-0'
                          else
                            'score-1'
                          end
                      %>
                      <i class="fas fa-minus-circle <%= score_class %>" title="Stake Concentration Score = <%= validator.stake_concentration_score %>"></i>&nbsp;
                    <% end %>
                  </small>
                  (<%= validator.total_score %>)
              </td>
              <td class="score-<%= validator.root_distance_score %> text-right">
                <%= number_with_delimiter validator.tower_blocks_behind_leader %>
              </td>
              <td class="score-<%= validator.vote_distance_score %> text-right">
                <%= number_with_delimiter validator.tower_votes_behind_leader %>
              </td>
              <td class="score-<%= validator.skipped_slot_score %> text-right">
                <%=
                  if validator.skipped_slot_percent.nil?
                    'N/A'
                  else
                    number_to_percentage(validator.skipped_slot_percent.to_f * 100.0)
                  end
                 %>
              </td>
              <td class="score-<%= validator.skipped_after_score %> text-right">
                <%=
                  if validator.skipped_after_percent.nil?
                    'N/A'
                  else
                    number_to_percentage(validator.skipped_after_percent.to_f * 100.0)
                  end
                %>
              </td>

              <%
                ping_color = if validator.ping_time_avg.nil?
                  'score-0'
                elsif validator.ping_time_avg.to_f <= @ping_time_avg.to_f
                  'score-2'
                else
                  'score-1'
                end
               %>
              <td class="<%= ping_color %> text-right">
                <%= validator.ping_time_avg.nil? ? 'N/A' : validator.ping_time_avg.to_f.round(1)  %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
      <small>Data updated at <%= @batch.created_at %> in batch <%= @batch.uuid %></small>
    </div>
  </div>
<% end %>
<hr />
<% if @software_versions %>
  <h3>Software Versions</h3>
  <div class="row">
    <div class="col-lg-12">
      <table class="table table-striped">
        <thead class="thead-dark">
          <tr>
            <th>Software Version</th>
            <th>Count</th>
          </tr>
        </thead>
        <tbody>
          <% @software_versions.payload.each do |group| %>
            <tr>
              <td><%= group.first[0] %></td>
              <td><%= group.first[1] %></td>
            </tr>
          <% end %>
        </tbody>

      </table>
    </div>
  </div>
<% end %>
